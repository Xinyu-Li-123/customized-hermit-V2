{{ define "header" }}
{{ partialCached "header.html" . }}
{{ end }}

{{ define "main" }}

	{{ if .Site.Params.bgImg -}}
	<style>.bg-img {background-image: url('{{.Site.Params.bgImg}}'); opacity: 0.2 !important}</style>
	{{- else if .Site.Params.images -}}
		{{- range first 1 .Site.Params.images -}}
		<style>.bg-img {background-image: url('{{. | absURL}}');}</style>
		{{- end -}}
	{{- end -}}
	{{- if (or .Site.Params.images .Site.Params.bgImg) }}
	<div class="bg-img"></div>
	{{- end }}

	<style>
		.list-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1.5rem;
		}

		.list-header h1 {
			margin: 0;
		}

		.view-toggle-btn {
			background: none;
			border: 1px solid var(--fg-color, #333);
			border-radius: 4px;
			padding: 0.5rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s ease;
			opacity: 0.7;
		}

		.view-toggle-btn:hover {
			opacity: 1;
			background: var(--midnightblue, rgba(0, 0, 0, 0.05));
		}

		.view-toggle-btn:active {
			transform: scale(0.95);
		}

		.toggle-icon {
			display: block;
		}

		.view-container {
			transition: opacity 0.2s ease;
		}

		@media (max-width: 768px) {
			.list-header {
				flex-direction: row;
			}

			.view-toggle-btn {
				padding: 0.4rem;
			}

			.toggle-icon {
				width: 18px;
				height: 18px;
			}
		}
	</style>

	<main class="site-main section-inner thin {{- if ne false .Site.Params.usesAnimation }} animated fadeIn faster{{- end -}}">
		<div class="list-header">
			<h1>{{ .Title }}</h1>
			<button id="view-toggle" class="view-toggle-btn" title="Toggle between folder view and list view">
				<svg class="toggle-icon folder-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
				</svg>
				<svg class="toggle-icon list-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="8" y1="6" x2="21" y2="6"></line>
					<line x1="8" y1="12" x2="21" y2="12"></line>
					<line x1="8" y1="18" x2="21" y2="18"></line>
					<line x1="3" y1="6" x2="3.01" y2="6"></line>
					<line x1="3" y1="12" x2="3.01" y2="12"></line>
					<line x1="3" y1="18" x2="3.01" y2="18"></line>
				</svg>
			</button>
		</div>
		{{- if .Content }}
		<div class="content">
			{{ .Content }}
		</div>
		{{- end }}

		<!-- Folder View (Hierarchical) -->
		<div id="folder-view" class="view-container">
		{{- if and (ge (len (where .Site.Pages ".Params.pin" true)) 1) (.Site.Params.pinned) (not (in .Page.RelPermalink (or "tags" "categories"))) -}}
		<h2>{{- .Site.Params.pinned -}}</h2>
		{{$pin_name := .Site.Params.pinnedSVGname | default "pin" }}
		<div class="pinned-posts-group">
			<ul class="pinned-posts-list">
				{{- range where .Site.Pages ".Params.pin" true }}
				<li class="pinned-post-item">
					{{- partial "svg.html" (dict "context" . "name" $pin_name) }}
					<a href="{{.Permalink}}"><span class="post-title">{{.Title}}</span></a>
				</li>
				{{- end }}
			</ul>
		</div>
		{{- end -}}
		
		<!-- FIXME: This only search the direct children leaf bundles. Need to recursively search for all posts -->
		<!-- Select most recent posts from current section and all subsections -->

		<!-- `default arg1 arg2` returns `arg2` if it's set, o/w returns `arg1 -->
		 <!-- Thus the precedence is .Params.displayRecent > .Site.Params.displayRecent > false -->
		{{ $displayRecent := default false (default .Site.Params.displayRecent .Params.displayRecent) }}

		{{- if $displayRecent -}}

		{{ $recentCount := default 3 (default .Site.Params.recentCount .Params.recentCount) }}
		{{ $recentTitle := default "Recent Posts" (default .Site.Params.recentTitle .Params.recentTitle) }}

		{{- $currentSection := .CurrentSection }}
		{{- $allRelevantPages := slice }}

		<!-- Collect all posts from the current section and its nested subsections -->
		{{- range $currentSection.Sections }}
			{{- $allRelevantPages = $allRelevantPages | append .RegularPages }}
			{{- range .Sections }}
				{{- $allRelevantPages = $allRelevantPages | append .RegularPages }}
			{{- end }}
		{{- end }}

		<!-- Also include pages directly under the current section -->
		{{- $allRelevantPages = $allRelevantPages | append $currentSection.RegularPages }}

		<!-- Sort by last modified date and limit to the most recent X posts -->
		{{- $recentPosts := first $recentCount (sort $allRelevantPages ".Lastmod" "desc") }}

		{{- if gt (len $recentPosts) 0 }}
		<h2>{{- $recentTitle -}}</h2>
		<div class="posts-group">
			<ul class="posts-list">
				{{- range $recentPosts }}
				<li class="post-item">
					<a href="{{ .RelPermalink }}">
						<span class="post-title">{{ .Title }}</span>
						<span class="post-day">{{ .Lastmod.Format "2006-01-02" }}</span>
					</a>
					{{- if and .Params.description .Site.Params.descriptionInPosts -}}
					<span class="post-description">{{ .Params.description }}</span>
					{{- end }}
				</li>
				{{- end }}
			</ul>
		</div>
		{{- end }}

		{{- end }}


		 <!-- TODO: Provide option to Sort by lastmod, or by title -->
		{{ $sortPostBy := default "date" (default .Site.Params.sortPostBy .Params.sortPostBy) }}

		{{- if eq $sortPostBy "title" -}}

			{{- $sortedPages := sort .Data.Pages ".Title" "asc" }}
			<div class="posts-group">
				<ul class="posts-list">
					{{- range where $sortedPages ".Params.pin" "ne" true }}
					<li class="post-item">
						<a href="{{ .Permalink }}">
							<span class="post-title">{{ .Title }}</span>
							<span class="post-day">{{ .Lastmod.Format .Site.Params.dateformShort }}</span>
						</a>
						{{- if and .Page.Params.description .Site.Params.descriptionInPosts -}}
							<span class="post-description">{{ .Page.Params.description }}</span>
						{{- end }}
					</li>
				{{- end }}
				</ul>
			</div>


		{{- else if eq $sortPostBy "date" -}}

			{{- range .Data.Pages.GroupByLastmod "2006" }}
			{{ $pages := len (.Pages) }}
			{{ $pages_pin := len ( where .Pages ".Params.pin" "eq" true) }}
			{{- if gt $pages $pages_pin -}}
			<div class="posts-group">
				<div class="post-year" id="{{ .Key }}">{{ .Key }}</div>
				<ul class="posts-list">
					{{- range where .Pages ".Params.pin" "ne" true }}
					<li class="post-item">
						<a href="{{.Permalink}}">
							<span class="post-title">{{.Title}}</span>
							<span class="post-day">{{ .Lastmod.Format .Site.Params.dateformShort }}</span>
						</a>
						{{- if and .Page.Params.description .Site.Params.descriptionInPosts -}}
						<span class="post-description">{{ .Page.Params.description }}</span>
						{{- end -}}
					</li>
					{{- end }}
				</ul>
			</div>
			{{- end -}}
			{{- end }}

		{{- end -}}
		</div>
		<!-- End Folder View -->

		<!-- List View (Flat) -->
		<div id="list-view" class="view-container" style="display:none;">
		{{- $currentSection := .CurrentSection }}
		{{- $currentPath := $currentSection.RelPermalink }}
		{{- $allPosts := slice }}

		<!-- Collect all regular pages that are descendants of current section -->
		{{- range .Site.RegularPages }}
			{{- if hasPrefix .RelPermalink $currentPath }}
				{{- $allPosts = $allPosts | append . }}
			{{- end }}
		{{- end }}

		{{- $allPosts = sort $allPosts ".Lastmod" "desc" }}

		{{- if gt (len $allPosts) 0 }}
		<h2>All Posts ({{ len $allPosts }})</h2>
		<div class="posts-group">
			<ul class="posts-list">
				{{- range $allPosts }}
				<li class="post-item">
					<a href="{{ .RelPermalink }}">
						<span class="post-title">{{ .Title }}</span>
						<span class="post-day">{{ .Lastmod.Format "2006-01-02" }}</span>
					</a>
					{{- if and .Params.description $.Site.Params.descriptionInPosts -}}
					<span class="post-description">{{ .Params.description }}</span>
					{{- end }}
				</li>
				{{- end }}
			</ul>
		</div>
		{{- end }}
		</div>
		<!-- End List View -->

		<!-- Toggle View JavaScript -->
		<script>
		(function() {
			const toggleBtn = document.getElementById('view-toggle');
			const folderView = document.getElementById('folder-view');
			const listView = document.getElementById('list-view');
			const folderIcon = document.querySelector('.folder-icon');
			const listIcon = document.querySelector('.list-icon');

			// Use current section path as storage key
			const storageKey = 'view-mode-{{ .CurrentSection.RelPermalink }}';

			// Get saved preference or default to folder view
			let currentView = localStorage.getItem(storageKey) || 'folder';

			function showFolderView() {
				folderView.style.display = 'block';
				listView.style.display = 'none';
				folderIcon.style.display = 'block';
				listIcon.style.display = 'none';
				currentView = 'folder';
				localStorage.setItem(storageKey, 'folder');
			}

			function showListView() {
				folderView.style.display = 'none';
				listView.style.display = 'block';
				folderIcon.style.display = 'none';
				listIcon.style.display = 'block';
				currentView = 'list';
				localStorage.setItem(storageKey, 'list');
			}

			// Apply saved preference on load
			if (currentView === 'list') {
				showListView();
			} else {
				showFolderView();
			}

			// Toggle on button click
			toggleBtn.addEventListener('click', function() {
				if (currentView === 'folder') {
					showListView();
				} else {
					showFolderView();
				}
			});
		})();
		</script>

	</main>
{{ end }}

{{ define "footer" }}
{{ partialCached "footer.html" . }}
{{ end }}
